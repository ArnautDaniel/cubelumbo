const rl = @import("raylib");
const rm = @import("raymath");

const Rect = rl.Rectangle;
const Vec2 = rl.Vector2;
const Color = rl.Color;
const Camera2D = rl.Camera2D;

const NAME_OFFSET = 65;
const NAME_FONT_SIZE = 16;
const CUR_ENT_ID: u64 = 0;

const Walkable = struct {
    x: f32,
    y: f32,
    speed: f32,
};

const Drawable = struct {
    rect: Rect,
    color: rl.Color,

    pub fn draw(self: Drawable) void {
        rl.drawRectangleRec(self.position, self.color);
        rl.drawText(self.name, @as(i32, @intFromFloat(self.position.x)), @as(i32, @intFromFloat(self.position.y)) + NAME_OFFSET, NAME_FONT_SIZE, self.color);
    }
};

const Entity = struct {
    position: Rect,
    name: [:0]const u8,
    color: rl.Color,

    pub fn getCollide(self: Entity, other: Entity) bool {
        return rl.checkCollisionRecs(self.position, other.position);
    }
};

const ConsoleBox = struct {
    posx: i32 = 0,
    posy: i32 = 0,
    lines: [3][:0]const u8,

    pub fn draw(this: ConsoleBox) void {
        rl.drawRectangle(this.posx, this.posy, 400, 200, .black);
        for (this.lines, 0..) |line, i| {
            const n: i32 = @intCast(i);
            rl.drawText(line, this.posx, this.posy + n * 50, 20, .white);
        }
    }

    pub fn addLine(self: *ConsoleBox, str: [:0]const u8) void {
        self.lines[0] = self.lines[1];
        self.lines[1] = self.lines[2];
        self.lines[2] = str;
    }
};

pub fn main() anyerror!void {
    const screenWidth = 1080;
    const screenHeight = 1080;

    rl.initWindow(screenWidth, screenHeight, "DuckRPG");
    defer rl.closeWindow();
    rl.setTargetFPS(60);

    var console = ConsoleBox{ .lines = .{ "Welcome to Cubelumbo.", "Written By Goldenpants (oneword)", "With help from Duck" } };

    var player = Entity{ .position = Rect.init(700, 700, 60, 60), .color = .white, .name = "Cubelumbo" };

    const npc = Entity{ .position = Rect.init(800, 800, 60, 60), .color = .black, .name = "Suspect" };

    // Main game loop
    while (!rl.windowShouldClose()) {

        // Update
        //----------------------------------------------------------------------------------
        if (player.getCollide(npc)) {
            console.addLine("You have encountered el nigre");
        }
        if (rl.isKeyDown(.right)) {
            player.position.x += 2.0;
        }
        if (rl.isKeyDown(.left)) {
            player.position.x -= 2.0;
        }
        if (rl.isKeyDown(.up)) {
            player.position.y -= 2.0;
        }
        if (rl.isKeyDown(.down)) {
            player.position.y += 2.0;
        }

        const camera: rl.Camera2D = .{
            .target = Vec2.init(player.position.x, player.position.y),
            .offset = Vec2.init(screenWidth / 2, screenHeight / 2),
            .rotation = 0,
            .zoom = 1,
        };

        //----------------------------------------------------------------------------------

        // Draw
        //----------------------------------------------------------------------------------
        rl.beginDrawing();

        defer rl.endDrawing();

        rl.clearBackground(.gray);
        {
            rl.beginMode2D(camera);
            defer rl.endMode2D();

            rl.drawText("Welcome to Cubelumbo", screenWidth / 2, screenHeight / 2, 30, .black);
            player.draw();
            npc.draw();
        }
        console.draw();
        //----------------------------------------------------------------------------------
    }
}
